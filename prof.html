<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RunCycle — Mode Prof (Standalone)</title>
  <style>
    :root{
      --bg:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --line:#253247; --card:#0b1220;
      --primary:#2563eb; --green:#16a34a; --amber:#f59e0b; --red:#ef4444; --glass:rgba(255,255,255,0.04);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}
    body{font-size:18px}
    header{padding:28px 16px;text-align:center;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#0b1220,#0f172a)}
    h1{margin:0;font-size:clamp(26px,4vw,38px)}
    .sub{color:var(--muted)}
    main{max-width:980px;margin:0 auto;padding:18px 16px 50px}
    .grid{display:grid;gap:16px}
    .cols-2{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    .card{background:var(--glass);backdrop-filter: blur(6px);border:1px solid var(--line);border-radius:16px;padding:16px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:14px 18px;border-radius:12px;border:1px solid var(--line);background:#0b1220;color:var(--ink);cursor:pointer}
    .btn.primary{background:var(--primary)}
    .btn:hover{transform:translateY(-1px)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,select,textarea{width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--ink);font-size:18px}
    label{font-size:14px;color:var(--muted)}
    .pill{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);font-size:14px;color:var(--muted)}
    footer{border-top:1px solid var(--line);padding:20px 16px;text-align:center;color:var(--muted)}
    .hidden{display:none}

    /* Gate */
    .gate{position:fixed;inset:0;background:rgba(15,23,42,.96);display:grid;place-items:center;z-index:9999}
    .gate-card{background:#0b1220;border:1px solid var(--line);border-radius:16px;padding:20px;max-width:360px;width:92%}

    /* Preset tiles */
    .preset-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin:8px 0 6px}
    .preset{border:1px solid var(--line);border-radius:14px;padding:12px;background:#0b1220;cursor:pointer;display:grid;gap:6px;transition:transform .05s ease}
    .preset:hover{transform:translateY(-1px)}
    .preset .t{font-weight:700}
    .preset .d{color:var(--muted);font-size:13px}

    /* Sticky code banner */
    .code-sticky{position:sticky;top:6px;z-index:5;padding:10px 12px;border:1px solid #374151;border-radius:12px;background:#0b1220;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .code-banner{font:700 28px/1.2 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .code-btn{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#111827;color:#e5e7eb;cursor:pointer}

    /* Toast */
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#111827;border:1px solid #374151;color:#e5e7eb;padding:10px 14px;border-radius:10px;opacity:0;transition:opacity .2s}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <div id="gate" class="gate">
    <div class="gate-card">
      <h2>🔒 Accès Prof</h2>
      <p class="sub">Entrez le code pour ouvrir le mode Prof.</p>
      <div class="row"><input id="gateCode" type="password" inputmode="numeric" placeholder="Code" style="flex:1"><button class="btn primary" id="gateBtn">Ouvrir</button></div>
      <div id="gateErr" class="sub" style="color:#ef4444;margin-top:8px;display:none">Code incorrect</div>
      <div class="row" style="margin-top:10px"><a class="btn" href="./index.html">⬅️ Accueil</a></div>
    </div>
  </div>

  <header>
    <h1>RunCycle — Mode Prof</h1>
    <div class="sub">Séances type ou personnalisées • Donnez un <b>code oral</b> aux élèves</div>
  </header>

  <main>
    <!-- CODE BANNER -->
    <div class="code-sticky card">
      <div class="code-banner">CODE ÉLÈVES : <span id="unlockCode">—</span></div>
      <button class="code-btn" id="btnCopy">Copier le code</button>
    </div>

    <!-- PRESETS NICE -->
    <section class="card">
      <h2>⭐ Séances type</h2>
      <div class="preset-grid">
        <div class="preset" data-p="S1"><div class="t">S1 · Test 6’ (VMA)</div><div class="d">1×6’ · Estimation VMA</div></div>
        <div class="preset" data-p="S2"><div class="t">S2 · 2×6’ @ 90%</div><div class="d">r=3’ · Régularité</div></div>
        <div class="preset" data-p="S3"><div class="t">S3 · 3×4’ 80/90/100%</div><div class="d">r=2’ · Allures</div></div>
        <div class="preset" data-p="S4"><div class="t">S4 · 4×3’ 90→95%</div><div class="d">r=2’ · Projet</div></div>
        <div class="preset" data-p="S5"><div class="t">S5 · Éval 4×3’ @95%</div><div class="d">r=2’ · ±0,5 km/h</div></div>
      </div>
      <div class="sub">Astuce : cliquer une tuile remplit la séance ci-dessous.</div>
    </section>

    <section class="card" id="profMain">
      <h2>🗓️ Créer / choisir la séance</h2>
      <div class="grid cols-2">
        <div>
          <label>Sélection</label>
          <select id="preset">
            <option value="S1">S1 — Test 6’ (VMA)</option>
            <option value="S2" selected>S2 — 2×6’ @ 90% VMA • r=3’</option>
            <option value="S3">S3 — 3×4’ (80/90/100%) • r=2’</option>
            <option value="S4">S4 — 4×3’ projet (90→95%) • r=2’</option>
            <option value="S5">S5 — Évaluation 4×3’ @ 95% • r=2’</option>
          </select>
        </div>
        <div>
          <label>Date</label>
          <input id="sDate" type="date">
        </div>
        <div>
          <label>Titre</label>
          <input id="sTitre" placeholder="4×3’ r=2’ @ 95% VMA">
        </div>
        <div>
          <label>Longueur de piste (m) — saisir n'importe quelle valeur</label>
          <input id="sPiste" type="number" min="50" step="1" value="200" placeholder="ex: 180, 240, 325">
        </div>
        <div>
          <label>Nombre de blocs</label>
          <input id="sBlocs" type="number" min="1" value="4">
        </div>
        <div>
          <label>Durée d’un bloc (min)</label>
          <input id="sDuree" type="number" min="1" value="3">
        </div>
        <div>
          <label>Récupération (min)</label>
          <input id="sRecup" type="number" min="0" value="2">
        </div>
        <div>
          <label>% VMA (scalaire ou liste)</label>
          <input id="sPct" placeholder="0.95 ou 0.9,0.92,0.94,0.95" value="0.95">
        </div>
        <div style="grid-column:1/-1">
          <label>Consignes</label>
          <textarea id="sNotes" rows="3" placeholder="Régularité, départ prudent, finish propre"></textarea>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnPreset">↺ Charger séance type</button>
        <button class="btn primary" id="btnGen">🔐 Générer / actualiser le code</button>
      </div>
      <div class="row" style="margin-top:12px">
        <span class="pill">SeanceID : <span id="sid">—</span></span>
      </div>
      <div class="grid cols-2" style="margin-top:12px">
        <div>
          <label>Remplacer le code élèves (optionnel)</label>
          <input id="manualCode" placeholder="ex: 202B ou AB12CD34">
          <div class="sub">Si rempli, c’est ce code qui sera affiché et stocké pour cette séance.</div>
        </div>
      </div>
      <p class="sub" style="margin-top:6px">👉 Étapes : 1) Cliquer une tuile OU choisir la séance  2) “↺ Charger séance type”  3) “🔐 Générer / actualiser le code”  4) Dicter le code aux élèves.</p>
      <div class="row" style="margin-top:8px"><a class="btn" href="./index.html">⬅️ Retour</a></div>
    </section>
  </main>

  <footer>RunCycle — Équipe EPS Lycée Vauban — Luxembourg — JB</footer>

  <div id="toast" class="toast">Copié ✔</div>

  <script>
  // ===== Mini-coeur (aucune dépendance externe) =====
  const PRESETS = {
    S1: { Titre:"Test 6' (estimation VMA)", Blocs:1, DureeBloc_min:6, Recup_min:0, Cible_%VMA:[/* libre */], Notes:"Courir la plus grande distance en 6'." },
    S2: { Titre:"2×6' @ 90% VMA (r=3')", Blocs:2, DureeBloc_min:6, Recup_min:3, Cible_%VMA:[0.90,0.90], Notes:"Régularité, allure 90% VMA." },
    S3: { Titre:"3×4' aux allures 80/90/100% (r=2')", Blocs:3, DureeBloc_min:4, Recup_min:2, Cible_%VMA:[0.80,0.90,1.00], Notes:"Différencier les allures." },
    S4: { Titre:"4×3' projet @ 90–95% (r=2')", Blocs:4, DureeBloc_min:3, Recup_min:2, Cible_%VMA:[0.90,0.92,0.94,0.95], Notes:"Tenir le projet, finish propre." },
    S5: { Titre:"Éval 4×3' @ 95% (r=2')", Blocs:4, DureeBloc_min:3, Recup_min:2, Cible_%VMA:[0.95,0.95,0.95,0.95], Notes:"Objectif ±0,5 km/h." }
  };
  const PRESET_CODES = { S1:"101A", S2:"202B", S3:"303C", S4:"404D", S5:"505E" };

  // Gate 57 + URL unlock (?p=57 / #57)
  (function(){
    function qp(n){ const m=location.search.match(new RegExp('[?&]'+n+'=([^&]+)')); return m?decodeURIComponent(m[1]):null; }
    function hideGate(){ const g=document.getElementById('gate'); if(g) g.style.display='none'; }
    function auto(){ const h=(location.hash||'').replace('#','').trim(); const p=(qp('p')||qp('code')||'').trim(); if(h==='57'||p==='57') hideGate(); }
    function bind(){ const i=document.getElementById('gateCode'), b=document.getElementById('gateBtn'), e=document.getElementById('gateErr'); function unlock(){ const v=(i.value||'').trim(); if(v==='57'){ hideGate(); } else { e.style.display='block'; } } b.addEventListener('click',unlock); i.addEventListener('keydown',ev=>{ if(ev.key==='Enter') unlock(); }); }
    auto(); if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',bind);}else{bind();}
  })();

  // UI refs
  const codeSpan = document.getElementById('unlockCode');
  const sidSpan  = document.getElementById('sid');
  const presetSel= document.getElementById('preset');
  const dateIn   = document.getElementById('sDate');
  const titreIn  = document.getElementById('sTitre');
  const pisteIn  = document.getElementById('sPiste');
  const blocsIn  = document.getElementById('sBlocs');
  const dureeIn  = document.getElementById('sDuree');
  const recupIn  = document.getElementById('sRecup');
  const pctIn    = document.getElementById('sPct');
  const notesIn  = document.getElementById('sNotes');
  const manualCodeIn = document.getElementById('manualCode');
  const toast = document.getElementById('toast');

  // Helpers
  function today(){ return new Date().toISOString().slice(0,10); }
  function buildSession(){
    return {
      v:1,
      SeanceID: (dateIn.value||today()) + "_" + Math.random().toString(36).slice(2,6).toUpperCase(),
      Titre: titreIn.value || "Séance",
      Date: dateIn.value || today(),
      Blocs: Number(blocsIn.value||4),
      DureeBloc_min: Number(dureeIn.value||3),
      Recup_min: Number(recupIn.value||2),
      Cible_%VMA: String(pctIn.value||"0.95").split(',').map(x=>Number(x.trim())).filter(x=>!Number.isNaN(x)),
      Piste_m: Number(pisteIn.value||200),
      Consignes: notesIn.value||""
    };
  }
  function isExactlyPreset(){
    const p = PRESETS[presetSel.value];
    return (
      titreIn.value === p.Titre &&
      Number(blocsIn.value) === p.Blocs &&
      Number(dureeIn.value) === p.DureeBloc_min &&
      Number(recupIn.value) === p.Recup_min &&
      pctIn.value.replace(/\s+/g,'') === p.Cible_%VMA.join(',')
    );
  }
  function applyPreset(key){
    const p = PRESETS[key||presetSel.value];
    dateIn.value = dateIn.value || today();
    titreIn.value = p.Titre;
    blocsIn.value = p.Blocs;
    dureeIn.value = p.DureeBloc_min;
    recupIn.value = p.Recup_min;
    pctIn.value = p.Cible_%VMA.join(',');
    notesIn.value = p.Notes;
    pisteIn.value = pisteIn.value || 200;
  }
  function saveCustom(code, seance){
    const map = JSON.parse(localStorage.getItem('RC_custom_sessions')||'{}');
    map[code] = seance;
    localStorage.setItem('RC_custom_sessions', JSON.stringify(map));
  }
  function genCode(){
    const seance = buildSession();
    let code;
    const override = (manualCodeIn.value||'').trim().toUpperCase();
    if(override){
      code = override;
      // si ce n'est pas un code type, on stocke la séance pour usage local
      if(!Object.values(PRESET_CODES).includes(code)) saveCustom(code, seance);
    } else if(isExactlyPreset()){
      code = PRESET_CODES[presetSel.value] || '000X';
    } else {
      code = Math.random().toString(36).slice(2,10).toUpperCase();
      saveCustom(code, seance);
    }
    codeSpan.textContent = code;
    sidSpan.textContent = seance.SeanceID;
    localStorage.setItem('RC_last_seance', JSON.stringify({unlock:code, seance:seance}));
  }
  function copyCode(){
    const c = codeSpan.textContent.trim();
    if(!c || c==='—') return;
    navigator.clipboard?.writeText(c).then(()=>{ toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1200); });
  }

  // Bind UI
  document.getElementById('btnPreset').addEventListener('click', ()=>{ applyPreset(); genCode(); });
  document.getElementById('btnGen').addEventListener('click', genCode);
  document.getElementById('btnCopy').addEventListener('click', copyCode);
  document.querySelectorAll('.preset').forEach(tile=>{
    tile.addEventListener('click', ()=>{
      const key = tile.getAttribute('data-p');
      presetSel.value = key;
      applyPreset(key);
      genCode();
    });
  });
  presetSel.addEventListener('change', ()=>{ applyPreset(); genCode(); });

  // Init
  applyPreset('S2'); genCode();
  </script>
</body>
</html>
