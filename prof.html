
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RunCycle ‚Äî Mode Prof</title>
  <link rel="stylesheet" href="./style.css" />
  <script src="./qr-loader.js" defer></script>
  <script src="./qr.min.js" defer></script>
  <script src="./core.js" defer></script>
  <script defer>
  document.addEventListener('DOMContentLoaded', ()=>{
    const C = window.RunCycleCore;
    // Elements
    const presetSel = document.getElementById('preset');
    const dateIn = document.getElementById('sDate');
    const titreIn = document.getElementById('sTitre');
    const pisteSel = document.getElementById('sPiste');
    const blocsIn = document.getElementById('sBlocs');
    const dureeIn = document.getElementById('sDuree');
    const recupIn = document.getElementById('sRecup');
    const pctIn = document.getElementById('sPct');
    const notesIn = document.getElementById('sNotes');
    const codeSpan = document.getElementById('unlockCode');
    const sidSpan = document.getElementById('sid');
    const qrBox = document.getElementById('qrSeance');
    const codeTypeSpan = document.getElementById('codeType');

    function applyPreset(){
      const pkey = presetSel.value;
      const p = C.PRESETS[pkey];
      dateIn.value = dateIn.value || new Date().toISOString().slice(0,10);
      titreIn.value = p.Titre;
      blocsIn.value = p.Blocs;
      dureeIn.value = p.DureeBloc_min;
      recupIn.value = p.Recup_min;
      pctIn.value = p.Cible_%VMA.join(',');
      notesIn.value = p.Notes;
    }

    function genCode(){
      const isPreset = !!C.PRESETS[presetSel.value] &&
        titreIn.value === C.PRESETS[presetSel.value].Titre &&
        Number(blocsIn.value) === C.PRESETS[presetSel.value].Blocs &&
        Number(dureeIn.value) === C.PRESETS[presetSel.value].DureeBloc_min &&
        Number(recupIn.value) === C.PRESETS[presetSel.value].Recup_min &&
        pctIn.value.replace(/\s+/g,'') === C.PRESETS[presetSel.value].Cible_%VMA.join(',');

      let code;
      let seance = C.buildSession({
        Titre: titreIn.value, DateStr: dateIn.value, Blocs: blocsIn.value,
        DureeBloc_min: dureeIn.value, Recup_min: recupIn.value,
        CiblePct: pctIn.value, Piste_m: pisteSel.value, Notes: notesIn.value
      });

      if(isPreset){
        // Short code for presets
        const idx = Object.keys(C.PRESETS).indexOf(presetSel.value);
        code = C.genShortCode(idx);
        // Students will reconstruct from code locally (no details transferred)
        codeTypeSpan.textContent = 'code court (pr√©s√©lection)';
      } else {
        // Extended code for custom
        code = C.genExtendedCode();
        C.saveCustomSession(code, seance);
        codeTypeSpan.textContent = 'code √©tendu (s√©ance perso)';
      }

      codeSpan.textContent = code;
      sidSpan.textContent = seance.SeanceID;

      // Optional: QR s√©ance with JSON (if tu veux quand m√™me projeter)
      qrBox.innerHTML = '';
      if(typeof QRCode!=='undefined'){
        new QRCode(qrBox,{text: JSON.stringify({unlock:code, seance:seance}), width:220, height:220});
      }else{
        qrBox.innerHTML = '<div class="sub">QR lib non dispo ‚Äî le code suffit: <b>'+code+'</b></div>';
      }
      // Keep last on this device (utile si tablette prof == tablette √©l√®ves)
      localStorage.setItem('RC_last_seance', JSON.stringify({unlock:code, seance:seance}));
    }

    document.getElementById('btnPreset').addEventListener('click', applyPreset);
    document.getElementById('btnGen').addEventListener('click', genCode);
    // init
    applyPreset();

    // --- Gate access '57'
    const gate = document.getElementById('gate');
    const gateBtn = document.getElementById('gateBtn');
    const gateCode = document.getElementById('gateCode');
    const gateErr = document.getElementById('gateErr');
    function openGate(){
      if((gateCode.value||'').trim() === '57'){
        gate.style.display='none';
        // small focus
        presetSel.focus();
      }else{
        gateErr.style.display='block';
      }
    }
    gateBtn.addEventListener('click', openGate);
    gateCode.addEventListener('keydown', (e)=>{ if(e.key==='Enter') openGate(); });
    // --- Auto generate on preset change for quick flow
    presetSel.addEventListener('change', ()=>{ applyPreset(); genCode(); });

  });
  </script>
</head>
<body>
  
<style>
  .gate{position:fixed;inset:0;background:rgba(15,23,42,.96);display:grid;place-items:center;z-index:9999}
  .gate-card{background:#0b1220;border:1px solid #253247;border-radius:16px;padding:20px;max-width:360px;width:92%}
  .gate h2{margin-top:0}
</style>

  <div id="gate" class="gate">
    <div class="gate-card">
      <h2>üîí Acc√®s Prof</h2>
      <p class="sub">Entrez le code pour ouvrir le mode Prof.</p>
      <div class="row"><input id="gateCode" placeholder="Code (ex: 57)" style="flex:1"><button class="btn primary" id="gateBtn">Ouvrir</button></div>
      <div id="gateErr" class="sub" style="color:#ef4444;margin-top:8px;display:none">Code incorrect</div>
      <div class="sub" style="margin-top:8px">Astuce : vous pouvez revenir √† l‚Äôaccueil si besoin.</div>
      <div class="row" style="margin-top:10px"><a class="btn" href="./index.html">‚¨ÖÔ∏è Accueil</a></div>
    </div>
  </div>

  <header>
    <h1>RunCycle ‚Äî Mode Prof</h1>
    <div class="sub">S√©ances type <em>ou</em> personnalis√©es ‚Ä¢ Code simple (sans scan c√¥t√© √©l√®ves)</div>
  </header>
  <main>
    <section class="grid cols-2">
      <div class="card">
        <h2>üóìÔ∏è S√©ance</h2>
        <div class="grid cols-2">
          <div>
            <label>S√©ance type</label>
            <select id="preset">
              <option value="S1">S1 ‚Äî Test 6‚Äô (VMA)</option>
              <option value="S2">S2 ‚Äî 2√ó6‚Äô @ 90% VMA ‚Ä¢ r=3‚Äô</option>
              <option value="S3">S3 ‚Äî 3√ó4‚Äô (80/90/100%) ‚Ä¢ r=2‚Äô</option>
              <option value="S4">S4 ‚Äî 4√ó3‚Äô projet (90‚Üí95%) ‚Ä¢ r=2‚Äô</option>
              <option value="S5">S5 ‚Äî √âvaluation 4√ó3‚Äô @ 95% ‚Ä¢ r=2‚Äô</option>
            </select>
          </div>
          <div>
            <label>Date</label>
            <input id="sDate" type="date">
          </div>
          <div>
            <label>Titre</label>
            <input id="sTitre" placeholder="4√ó3‚Äô r=2‚Äô @ 95% VMA">
          </div>
          <div>
            <label>Longueur de piste (m)</label>
            <select id="sPiste">
              <option>200</option><option>250</option><option>300</option><option>333</option><option selected>400</option>
            </select>
          </div>
          <div>
            <label>Nombre de blocs</label>
            <input id="sBlocs" type="number" min="1" value="4">
          </div>
          <div>
            <label>Dur√©e d‚Äôun bloc (min)</label>
            <input id="sDuree" type="number" min="1" value="3">
          </div>
          <div>
            <label>R√©cup√©ration (min)</label>
            <input id="sRecup" type="number" min="0" value="2">
          </div>
          <div>
            <label>% VMA (scalaire ou liste)</label>
            <input id="sPct" placeholder="0.95 ou 0.9,0.92,0.94,0.95" value="0.95">
          </div>
          <div style="grid-column:1/-1">
            <label>Consignes</label>
            <textarea id="sNotes" rows="3" placeholder="R√©gularit√©, d√©part prudent, finish propre"></textarea>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn" id="btnPreset">‚Ü∫ Charger la s√©ance type</button>
          <button class="btn primary" id="btnGen">üîê G√©n√©rer code</button>
        </div>
      </div>

      <div class="card">
        <h2>üîê Code & (option) QR S√©ance</h2>
        <div class="row"><span class="pill">Code¬†: <span id="unlockCode">‚Äî</span></span><span class="pill">SeanceID¬†: <span id="sid">‚Äî</span></span></div>
        <div class="sub" style="margin-top:6px">Type¬†: <span id="codeType">‚Äî</span></div>
        <div id="qrSeance" class="qr-box" style="margin-top:10px"></div>
        <div class="sub">Les √©l√®ves n‚Äôont besoin que du <b>code</b>. Le QR s√©ance est facultatif.</div>
      </div>
    </section>
    <div class="center" style="margin-top:16px"><a class="btn" href="./index.html">‚¨ÖÔ∏è Retour</a></div>
  </main>
  <footer>RunCycle ‚Äî √âquipe EPS Lyc√©e Vauban ‚Äî Luxembourg ‚Äî JB</footer>
</body>
</html>
