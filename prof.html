
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RunCycle â€” Mode Prof</title>
  <link rel="stylesheet" href="./style.css" />
  <script src="./qr-loader.js" defer></script>
  <script src="./qr.min.js" defer></script>
  <script src="./core.js" defer></script>
  <script defer>
  document.addEventListener('DOMContentLoaded', ()=>{
    const C = window.RunCycleCore;
    // Elements
    const presetSel = document.getElementById('preset');
    const dateIn = document.getElementById('sDate');
    const titreIn = document.getElementById('sTitre');
    const pisteSel = document.getElementById('sPiste');
    const blocsIn = document.getElementById('sBlocs');
    const dureeIn = document.getElementById('sDuree');
    const recupIn = document.getElementById('sRecup');
    const pctIn = document.getElementById('sPct');
    const notesIn = document.getElementById('sNotes');
    const codeSpan = document.getElementById('unlockCode');
    const sidSpan = document.getElementById('sid');
    const qrBox = document.getElementById('qrSeance');
    const codeTypeSpan = document.getElementById('codeType');

    function applyPreset(){
      const pkey = presetSel.value;
      const p = C.PRESETS[pkey];
      dateIn.value = dateIn.value || new Date().toISOString().slice(0,10);
      titreIn.value = p.Titre;
      blocsIn.value = p.Blocs;
      dureeIn.value = p.DureeBloc_min;
      recupIn.value = p.Recup_min;
      pctIn.value = p.Cible_%VMA.join(',');
      notesIn.value = p.Notes;
    }

    function genCode(){
      const isPreset = !!C.PRESETS[presetSel.value] &&
        titreIn.value === C.PRESETS[presetSel.value].Titre &&
        Number(blocsIn.value) === C.PRESETS[presetSel.value].Blocs &&
        Number(dureeIn.value) === C.PRESETS[presetSel.value].DureeBloc_min &&
        Number(recupIn.value) === C.PRESETS[presetSel.value].Recup_min &&
        pctIn.value.replace(/\s+/g,'') === C.PRESETS[presetSel.value].Cible_%VMA.join(',');

      let code;
      let seance = C.buildSession({
        Titre: titreIn.value, DateStr: dateIn.value, Blocs: blocsIn.value,
        DureeBloc_min: dureeIn.value, Recup_min: recupIn.value,
        CiblePct: pctIn.value, Piste_m: pisteSel.value, Notes: notesIn.value
      });

      if(isPreset){
        // Short code for presets
        const idx = Object.keys(C.PRESETS).indexOf(presetSel.value);
        code = C.genShortCode(idx);
        // Students will reconstruct from code locally (no details transferred)
        codeTypeSpan.textContent = 'code court (prÃ©sÃ©lection)';
      } else {
        // Extended code for custom
        code = C.genExtendedCode();
        C.saveCustomSession(code, seance);
        codeTypeSpan.textContent = 'code Ã©tendu (sÃ©ance perso)';
      }

      codeSpan.textContent = code;
      sidSpan.textContent = seance.SeanceID;

      // Optional: QR sÃ©ance with JSON (if tu veux quand mÃªme projeter)
      /* QR sÃ©ance dÃ©sactivÃ© */// Keep last on this device (utile si tablette prof == tablette Ã©lÃ¨ves)
      localStorage.setItem('RC_last_seance', JSON.stringify({unlock:code, seance:seance}));
    }

    document.getElementById('btnPreset').addEventListener('click', applyPreset);
    document.getElementById('btnGen').addEventListener('click', genCode);
    // init
    applyPreset();

    // === Robust Gate '57' (no hints, no deps) ===
    (function(){
      var gate = document.getElementById('gate');
      var btn = document.getElementById('gateBtn');
      var inp = document.getElementById('gateCode');
      var err = document.getElementById('gateErr');
      function unlock(){
        var v = (inp.value||'').trim();
        if(v === '57'){ gate.style.display='none'; try{ document.getElementById('preset').focus(); }catch(e){} }
        else { err.style.display='block'; }
      }
      if(btn){ btn.addEventListener('click', unlock); }
      if(inp){ inp.addEventListener('keydown', function(e){ if(e.key==='Enter'){ unlock(); }}); }
    })();
    
    // --- Gate access '57'
    const gate = document.getElementById('gate');
    const gateBtn = document.getElementById('gateBtn');
    const gateCode = document.getElementById('gateCode');
    const gateErr = document.getElementById('gateErr');
    function openGate(){
      if((gateCode.value||'').trim() === '57'){
        gate.style.display='none';
        // small focus
        presetSel.focus();
      }else{
        gateErr.style.display='block';
      }
    }
    gateBtn.addEventListener('click', openGate);
    gateCode.addEventListener('keydown', (e)=>{ if(e.key==='Enter') openGate(); });
    // --- Auto generate on preset change for quick flow
    presetSel.addEventListener('change', ()=>{ applyPreset(); genCode(); });

  });
  </script>
</head>
<body>
  
<style>
  .gate{position:fixed;inset:0;background:rgba(15,23,42,.96);display:grid;place-items:center;z-index:9999}
  .gate-card{background:#0b1220;border:1px solid #253247;border-radius:16px;padding:20px;max-width:360px;width:92%}
  .gate h2{margin-top:0}
</style>

  <div id="gate" class="gate">
    <div class="gate-card">
      <h2>ğŸ”’ AccÃ¨s Prof</h2>
      <p class="sub">Entrez le code pour ouvrir le mode Prof.</p>
      <div class="row"><input id="gateCode" type="password" placeholder="Code" inputmode="numeric" style="flex:1"><button class="btn primary" id="gateBtn">Ouvrir</button></div>
      <div id="gateErr" class="sub" style="color:#ef4444;margin-top:8px;display:none">Code incorrect</div>
      <div class="sub" style="margin-top:8px">Astuce : vous pouvez revenir Ã  lâ€™accueil si besoin.</div>
      <div class="row" style="margin-top:10px"><a class="btn" href="./index.html">â¬…ï¸ Accueil</a></div>
    </div>
  </div>

<script>
(function(){
  function getParam(name){
    var m=location.search.match(new RegExp('[?&]'+name+'=([^&]+)')); return m? decodeURIComponent(m[1]) : null;
  }
  function autoUnlockIfNeeded(){
    var hash = (location.hash||'').replace('#','').trim();
    var qp = (getParam('p')||getParam('code')||'').trim();
    if(hash==='57' || qp==='57'){
      var gate = document.getElementById('gate');
      if(gate){ gate.style.display='none'; }
    }
  }
  function bindGate(){
    var gate=document.getElementById('gate'), btn=document.getElementById('gateBtn'), inp=document.getElementById('gateCode'), err=document.getElementById('gateErr');
    if(!gate||!btn||!inp) return;
    function unlock(){
      var v=(inp.value||'').trim();
      if(v==='57'){ gate.style.display='none'; try{ document.getElementById('preset').focus(); }catch(e){} }
      else { if(err) err.style.display='block'; }
    }
    btn.addEventListener('click', unlock);
    inp.addEventListener('keydown', function(e){ if(e.key==='Enter'){ unlock(); }});
  }
  // Run now and also on DOM ready
  autoUnlockIfNeeded();
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', function(){ autoUnlockIfNeeded(); bindGate(); });
  }else{
    bindGate();
  }
})();
</script>


  <header>
    <h1>RunCycle â€” Mode Prof</h1>
    <div class="sub">SÃ©ances type <em>ou</em> personnalisÃ©es â€¢ Code simple (sans scan cÃ´tÃ© Ã©lÃ¨ves)</div>
  </header>
  <main>
    <section class="grid cols-2">
      <div class="card">
        <h2>ğŸ—“ï¸ SÃ©ance</h2>
        <div class="grid cols-2">
          <div>
            <label>SÃ©ance type</label>
            <select id="preset">
              <option value="S1">S1 â€” Test 6â€™ (VMA)</option>
              <option value="S2">S2 â€” 2Ã—6â€™ @ 90% VMA â€¢ r=3â€™</option>
              <option value="S3">S3 â€” 3Ã—4â€™ (80/90/100%) â€¢ r=2â€™</option>
              <option value="S4">S4 â€” 4Ã—3â€™ projet (90â†’95%) â€¢ r=2â€™</option>
              <option value="S5">S5 â€” Ã‰valuation 4Ã—3â€™ @ 95% â€¢ r=2â€™</option>
            </select>
          </div>
          <div>
            <label>Date</label>
            <input id="sDate" type="date">
          </div>
          <div>
            <label>Titre</label>
            <input id="sTitre" placeholder="4Ã—3â€™ r=2â€™ @ 95% VMA">
          </div>
          <div>
            <label>Longueur de piste (m)</label>
            <select id="sPiste">
              <option>200</option><option>250</option><option>300</option><option>333</option><option selected>400</option>
            </select>
          </div>
          <div>
            <label>Nombre de blocs</label>
            <input id="sBlocs" type="number" min="1" value="4">
          </div>
          <div>
            <label>DurÃ©e dâ€™un bloc (min)</label>
            <input id="sDuree" type="number" min="1" value="3">
          </div>
          <div>
            <label>RÃ©cupÃ©ration (min)</label>
            <input id="sRecup" type="number" min="0" value="2">
          </div>
          <div>
            <label>% VMA (scalaire ou liste)</label>
            <input id="sPct" placeholder="0.95 ou 0.9,0.92,0.94,0.95" value="0.95">
          </div>
          <div style="grid-column:1/-1">
            <label>Consignes</label>
            <textarea id="sNotes" rows="3" placeholder="RÃ©gularitÃ©, dÃ©part prudent, finish propre"></textarea>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn" id="btnPreset">â†º Charger la sÃ©ance type</button>
          <button class="btn primary" id="btnGen">ğŸ” GÃ©nÃ©rer code</button>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ” Code & (option) QR SÃ©ance</h2>
        <div class="row"><span class="pill">CodeÂ : <span id="unlockCode">â€”</span></span><span class="pill">SeanceIDÂ : <span id="sid">â€”</span></span></div>
        <div class="sub" style="margin-top:6px">TypeÂ : <span id="codeType">â€”</span></div>
        <div class="sub" style="margin-top:10px">Donnez uniquement le <b>code</b> aux Ã©lÃ¨ves (pas de QR sÃ©ance).</div>
      </div>
    </section>
    <div class="center" style="margin-top:16px"><a class="btn" href="./index.html">â¬…ï¸ Retour</a></div>
  </main>
  <footer>RunCycle â€” Ã‰quipe EPS LycÃ©e Vauban â€” Luxembourg â€” JB</footer>
</body>
</html>
