<!DOCTYPE html><html lang="fr"><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RunCycle — Élèves</title>
<style>
:root{--bg:#0b1020;--ink:#e6e9ef;--muted:#9aa4b2;--line:#222b3c;--panel:#0f172a}
*{box-sizing:border-box}html,body{margin:0}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0b1020;color:var(--ink)}
header,footer{border-block:1px solid var(--line);padding:22px;text-align:center}
main{max-width:980px;margin:0 auto;padding:20px}
.card{background:#0f172a;border:1px solid var(--line);border-radius:14px;padding:18px;margin:12px 0}
.grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
.btn{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#0f172a;color:var(--ink);cursor:pointer;text-decoration:none;font-weight:700}
input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b1428;color:var(--ink);font-size:18px}
table{width:100%;border-collapse:collapse}th,td{border:1px solid var(--line);padding:8px;text-align:left}
.time{font:800 34px/1 ui-monospace,Menlo,Consolas,monospace;padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#111827}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--muted)}
.finish{padding:10px;border:1px solid var(--line);border-radius:10px;background:#0a1a36;display:none;margin-top:8px}
</style>
<body>
<header><h1>RunCycle — Élèves</h1><div style="color:#94a3b8">Code → VMA & piste → cibles → chrono → saisie → QR</div></header>
<main>
  <div class="card">
    <h2>Charger la séance</h2>
    <div class="grid">
      <div><label>Code séance</label><input id="code" placeholder="ex: 202B"></div>
      <div><label>Piste (m)</label><input id="piste" type="number" min="50" value="200"></div>
    </div>
    <div style="margin-top:8px"><button class="btn" onclick="load()">Utiliser le code</button></div>
    <div id="desc" class="badge" style="display:none;margin-top:8px"></div>
  </div>

  <div id="profiles" class="grid" style="display:none">
    <div class="card"><h3>Élève A</h3><div class="grid">
      <div><label>Nom</label><input id="aNom"></div><div><label>Prénom</label><input id="aPre"></div>
      <div><label>Classe</label><input id="aCla"></div><div><label>Sexe</label><select id="aSex"><option>F</option><option>M</option></select></div>
      <div><label>VMA (km/h)</label><input id="aVMA" type="number" step="0.1" oninput="targets()"></div>
    </div></div>
    <div class="card"><h3>Élève B</h3><div class="grid">
      <div><label>Nom</label><input id="bNom"></div><div><label>Prénom</label><input id="bPre"></div>
      <div><label>Classe</label><input id="bCla"></div><div><label>Sexe</label><select id="bSex"><option>F</option><option selected>M</option></select></div>
      <div><label>VMA (km/h)</label><input id="bVMA" type="number" step="0.1" oninput="targets()"></div>
    </div></div>
  </div>

  <div id="work" class="card" style="display:none">
    <h2>Cibles & Chrono</h2>
    <div id="tg" class="badge">Renseignez les VMA…</div>
    <p><span class="badge" id="phase">Prêt</span> <span class="time" id="clock">00:00</span>
      <button class="btn" id="bStart">Start</button> <button class="btn" id="bPause">Pause</button> <button class="btn" id="bReset">Reset</button>
      <span class="badge">Bloc <span id="i">0</span>/<span id="n">0</span></span></p>
    <div id="finished" class="finish">✅ Séance terminée — bravo !</div>
  </div>

  <div id="saisie" class="card" style="display:none">
    <h2>Saisie & QR</h2>
    <table><thead><tr><th>Bloc</th><th>Distance A (m)</th><th>RPE A</th><th>Distance B (m)</th><th>RPE B</th></tr></thead><tbody id="tb"></tbody></table>
    <p style="margin-top:8px"><button class="btn" onclick="qr('duo')">QR DUO</button> <button class="btn" onclick="qr('A')">QR A</button> <button class="btn" onclick="qr('B')">QR B</button></p>
    <div id="q"></div>
  </div>
</main>
<footer>RunCycle — EPS Lycée Vauban — Luxembourg — JB</footer>

<script>
const PRESETS={
 "101A":{T:"Test 6' (VMA)",B:1,Db:6,R:0,P:[]},
 "202B":{T:"2×6' @90% (r=3')",B:2,Db:6,R:3,P:[0.9,0.9]},
 "303C":{T:"3×4' 80/90/100% (r=2')",B:3,Db:4,R:2,P:[0.8,0.9,1.0]},
 "404D":{T:"4×3' 90→95% (r=2')",B:4,Db:3,R:2,P:[0.9,0.92,0.94,0.95]},
 "505E":{T:"Éval 4×3' @95% (r=2')",B:4,Db:3,R:2,P:[0.95,0.95,0.95,0.95]}
};
let S=null, running=false, rem=0, ph='Prêt', b=0;

function load(){
  const c=(document.getElementById('code').value||'').trim().toUpperCase(); 
  if(!PRESETS[c]){ alert('Code inconnu : 101A, 202B, 303C, 404D, 505E'); return; }
  const piste=+document.getElementById('piste').value||200, p=PRESETS[c]; 
  S={T:p.T,B:p.B,Db:p.Db,R:p.R,P:p.P,Piste:piste};
  document.getElementById('desc').textContent=p.T+' • '+p.B+'×'+p.Db+"' r="+p.R+"' • piste '+piste+' m';
  document.getElementById('desc').style.display='inline-block';
  document.getElementById('profiles').style.display='grid';
  document.getElementById('work').style.display='block';
  document.getElementById('saisie').style.display='block';
  document.getElementById('n').textContent=S.B;
  build(); targets(); reset();
  document.getElementById('bStart').onclick=start;
  document.getElementById('bPause').onclick=pause;
  document.getElementById('bReset').onclick=reset;
}
function build(){ const tb=document.getElementById('tb'); tb.innerHTML=''; for(let i=1;i<=S.B;i++){tb.insertAdjacentHTML('beforeend','<tr><td>'+i+'</td><td><input id=a_m_'+i+' type=number min=0></td><td><input id=a_r_'+i+' type=number min=0 max=10></td><td><input id=b_m_'+i+' type=number min=0></td><td><input id=b_r_'+i+' type=number min=0 max=10></td></tr>');}}
function mpm(k){return k*1000/60}
function targets(){
  const a=+document.getElementById('aVMA').value||0, bb=+document.getElementById('bVMA').value||0, pct=S.P.length?S.P:Array(S.B).fill(1);
  const dA=a?pct.map(p=>Math.round(mpm(a*p)*S.Db)):[], dB=bb?pct.map(p=>Math.round(mpm(bb*p)*S.Db)):[];
  document.getElementById('tg').innerHTML=(a||bb)?('Cibles — A: <b>'+ (dA.join(' • ')||'—') + '</b> | B: <b>' + (dB.join(' • ')||'—') + '</b>'):'Renseignez les VMA…';
}
function fmt(s){const m=Math.floor(s/60),x=s%60; return String(m).padStart(2,'0')+':'+String(x).padStart(2,'0');}
function setPhase(p,sec){ph=p;rem=sec;document.getElementById('phase').textContent=p;document.getElementById('clock').textContent=fmt(rem);}
function tick(){
  if(!running) return;
  if(rem>0){ rem--; document.getElementById('clock').textContent = fmt(rem); return; }
  if(ph==='Effort'){
    if(b>=S.B){ stopAll(true); return; } // fin au dernier effort
    if(S.R>0){ setPhase('Récup', S.R*60); } else { b++; document.getElementById('i').textContent=b; setPhase('Effort', S.Db*60); }
    return;
  }
  if(ph==='Prêt'){ b=1; document.getElementById('i').textContent=b; setPhase('Effort', S.Db*60); return; }
  if(ph==='Récup'){ b++; document.getElementById('i').textContent=b; setPhase('Effort', S.Db*60); return; }
}
function start(){ if(!S||running) return; running=true; document.getElementById('finished').style.display='none'; if(rem<=0 && ph==='Prêt'){ setPhase('Effort', S.Db*60); } if(window._t) clearInterval(window._t); window._t=setInterval(tick,1000); }
function pause(){ running=false; if(window._t) clearInterval(window._t); }
function stopAll(f){ running=false; if(window._t) clearInterval(window._t); document.getElementById('phase').textContent=f?'Terminé':'Prêt'; document.getElementById('clock').textContent='00:00'; if(f) document.getElementById('finished').style.display='block'; }
function reset(){ stopAll(false); ph='Prêt'; b=0; rem=0; document.getElementById('i').textContent='0'; document.getElementById('finished').style.display='none';}
function kmh(m, min){ return (m/1000)/(min/60) } function mean(a){ return a.reduce((x,y)=>x+y,0)/a.length }
function qr(mode){
  const n=S.B, a={Nom:(document.getElementById('aNom').value||'').toUpperCase(),Prénom:document.getElementById('aPre').value||'',Classe:document.getElementById('aCla').value||'',Sexe:document.getElementById('aSex').value||'',VMA:+document.getElementById('aVMA').value||0},
        b2={Nom:(document.getElementById('bNom').value||'').toUpperCase(),Prénom:document.getElementById('bPre').value||'',Classe:document.getElementById('bCla').value||'',Sexe:document.getElementById('bSex').value||'',VMA:+document.getElementById('bVMA').value||0};
  const am=[],ar=[],bm=[],br=[]; for(let i=1;i<=n;i++){am.push(+document.getElementById('a_m_'+i).value||0);ar.push(+document.getElementById('a_r_'+i).value||0);bm.push(+document.getElementById('b_m_'+i).value||0);br.push(+document.getElementById('b_r_'+i).value||0);}
  const totMin=S.B*S.Db, vA=kmh(am.reduce((x,y)=>x+y,0),totMin), vB=kmh(bm.reduce((x,y)=>x+y,0),totMin), pct=S.P.length?S.P:Array(S.B).fill(1),
        cibleA=a.VMA?(a.VMA*mean(pct)):0, cibleB=b2.VMA?(b2.VMA*mean(pct)):0, ecA=+(vA-cibleA).toFixed(2), ecB=+(vB-cibleB).toFixed(2);
  let payload=null;
  if(mode==='duo'){ payload={v:1,format:'duo',Seance:S.T,Piste_m:S.Piste,eleves:[{Nom:a.Nom,Prénom:a.Prénom,Classe:a.Classe,Sexe:a.Sexe,VMA:a.VMA,Blocs_m:am,RPE:ar,Vitesse_moy_km_h:+vA.toFixed(2),Ecart_km_h:ecA},{Nom:b2.Nom,Prénom:b2.Prénom,Classe:b2.Classe,Sexe:b2.Sexe,VMA:b2.VMA,Blocs_m:bm,RPE:br,Vitesse_moy_km_h:+vB.toFixed(2),Ecart_km_h:ecB}]}; }
  else if(mode==='A'){ payload={v:1,format:'solo',Seance:S.T,Piste_m:S.Piste,Nom:a.Nom,Prénom:a.Prénom,Classe:a.Classe,Sexe:a.Sexe,VMA:a.VMA,Blocs_m:am,RPE:ar,Vitesse_moy_km_h:+vA.toFixed(2),Ecart_km_h:ecA}; }
  else { payload={v:1,format:'solo',Seance:S.T,Piste_m:S.Piste,Nom:b2.Nom,Prénom:b2.Prénom,Classe:b2.Classe,Sexe:b2.Sexe,VMA:b2.VMA,Blocs_m:bm,RPE:br,Vitesse_moy_km_h:+vB.toFixed(2),Ecart_km_h:ecB}; }
  const json=JSON.stringify(payload), url='https://api.qrserver.com/v1/create-qr-code/?size=220x220&data='+encodeURIComponent(json);
  document.getElementById('q').innerHTML='<div><img alt="QR" src="'+url+'"><textarea rows="5" style="width:100%;margin-top:8px">'+json+'</textarea></div>';
}
</script>
</body></html>
