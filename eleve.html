
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RunCycle ‚Äî Mode √âl√®ves (MVP)</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <header>
    <h1>RunCycle ‚Äî Mode √âl√®ves (Bin√¥me)</h1>
    <div class="sub">Code ‚Üí VMA + piste ‚Üí Cibles ‚Üí Chrono ‚Üí Distances + RPE ‚Üí QR DUO</div>
  </header>
  <main>
    <section class="card">
      <h2>üîì Charger la s√©ance</h2>
      <div class="grid cols-2">
        <div>
          <label>Code s√©ance (donn√© par le prof)</label>
          <input id="unlockIn" placeholder="ex: 202B (S2)">
        </div>
        <div>
          <label>Longueur de piste (m)</label>
          <input id="ePiste" type="number" min="50" step="1" value="200" placeholder="ex: 180, 240, 325">
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="btnLoad">‚úÖ Utiliser le code</button>
        <a class="btn" href="./index.html">‚¨ÖÔ∏è Accueil</a>
      </div>
      <div id="seanceLoaded" class="card hidden" style="margin-top:12px"></div>
    </section>

    <section class="grid cols-2 hidden" id="profiles">
      <div class="card">
        <h2>üë§ √âl√®ve A</h2>
        <div class="grid cols-2">
          <div><label>Nom</label><input id="aNom" placeholder="DUPONT"></div>
          <div><label>Pr√©nom</label><input id="aPrenom" placeholder="Alice"></div>
          <div><label>Classe</label><input id="aClasse" placeholder="4C"></div>
          <div><label>Sexe</label><select id="aSexe"><option>F</option><option>M</option></select></div>
          <div><label>VMA (km/h)</label><input id="aVMA" type="number" step="0.1"></div>
        </div>
      </div>
      <div class="card">
        <h2>üë§ √âl√®ve B</h2>
        <div class="grid cols-2">
          <div><label>Nom</label><input id="bNom" placeholder="MARTIN"></div>
          <div><label>Pr√©nom</label><input id="bPrenom" placeholder="Noah"></div>
          <div><label>Classe</label><input id="bClasse" placeholder="4C"></div>
          <div><label>Sexe</label><select id="bSexe"><option>F</option><option selected>M</option></select></div>
          <div><label>VMA (km/h)</label><input id="bVMA" type="number" step="0.1"></div>
        </div>
      </div>
    </section>

    <section id="sessionWork" class="card hidden">
      <h2>üéØ Cibles & Chrono</h2>
      <div id="targets" class="sub" style="margin-bottom:8px"></div>
      <div class="timer">
        <span class="pill" id="phase">Pr√™t</span>
        <span class="time" id="tclock">00:00</span>
        <button class="btn" id="tStart">‚ñ∂Ô∏è Start</button>
        <button class="btn" id="tPause">‚è∏Ô∏è Pause</button>
        <button class="btn" id="tReset">‚Ü∫ Reset</button>
        <span class="pill">Bloc <span id="blocIdx">0</span>/<span id="blocTot">0</span></span>
      </div>
    </section>

    <section id="saisieBlocs" class="card hidden">
      <h2>üìù Saisie des blocs & RPE</h2>
      <table>
        <thead><tr><th>Bloc</th><th>Distance A (m)</th><th>RPE A (0‚Äì10)</th><th>Distance B (m)</th><th>RPE B (0‚Äì10)</th></tr></thead>
        <tbody id="tbodyBlocs"></tbody>
      </table>
      <div class="row" style="margin-top:10px">
        <button class="btn green" id="btnQRDuo">üî≥ QR DUO (2 √©l√®ves)</button>
        <button class="btn" id="btnQRA">QR A</button>
        <button class="btn" id="btnQRB">QR B</button>
      </div>
      <div id="qrResult" class="card" style="margin-top:10px"></div>
    </section>
  </main>
  <footer>RunCycle ‚Äî √âquipe EPS Lyc√©e Vauban ‚Äî Luxembourg ‚Äî JB</footer>

  <script>
    const PRESETS = {
      "101A": { key:"S1", Titre:"Test 6' (estimation VMA)", Blocs:1, DureeBloc_min:6, Recup_min:0, Cible_%VMA:[], Notes:"" },
      "202B": { key:"S2", Titre:"2√ó6' @ 90% VMA (r=3')", Blocs:2, DureeBloc_min:6, Recup_min:3, Cible_%VMA:[0.90,0.90], Notes:"" },
      "303C": { key:"S3", Titre:"3√ó4' aux allures 80/90/100% (r=2')", Blocs:3, DureeBloc_min:4, Recup_min:2, Cible_%VMA:[0.80,0.90,1.00], Notes:"" },
      "404D": { key:"S4", Titre:"4√ó3' projet @ 90‚Äì95% (r=2')", Blocs:4, DureeBloc_min:3, Recup_min:2, Cible_%VMA:[0.90,0.92,0.94,0.95], Notes:"" },
      "505E": { key:"S5", Titre:"√âval 4√ó3' @ 95% (r=2')", Blocs:4, DureeBloc_min:3, Recup_min:2, Cible_%VMA:[0.95,0.95,0.95,0.95], Notes:"Objectif ¬±0,5 km/h." }
    };
    let current = null, timer=null, remaining=0, phase='Pr√™t', bloc=0;

    function loadFromCode(){
      const code = (document.getElementById('unlockIn').value||'').trim().toUpperCase();
      if(!code){ alert('Entrez le code'); return; }
      const preset = PRESETS[code];
      if(!preset){ alert('Code inconnu : utilisez 101A..505E'); return; }
      const piste = Number(document.getElementById('ePiste').value||200);
      current = {...preset, Piste_m:piste, SeanceID:(new Date().toISOString().slice(0,10))+'_'+Math.random().toString(36).slice(2,6).toUpperCase()};
      renderSeance(); buildBlocTable(); setupTimer();
      document.getElementById('profiles').classList.remove('hidden');
      document.getElementById('sessionWork').classList.remove('hidden');
      document.getElementById('saisieBlocs').classList.remove('hidden');
    }

    function renderSeance(){
      const s=current;
      const div=document.getElementById('seanceLoaded');
      div.innerHTML = '<div class="row"><span class="pill">'+s.Titre+'</span><span class="pill">Blocs: '+s.Blocs+' ‚Ä¢ '+s.DureeBloc_min+"' r="+s.Recup_min+"'</span><span class="pill">Piste: '+s.Piste_m+' m</span></div>';
      div.classList.remove('hidden');
      document.getElementById('blocTot').textContent = s.Blocs;
    }

    function buildBlocTable(){
      const s=current, tb=document.getElementById('tbodyBlocs'); tb.innerHTML='';
      for(let i=1;i<=s.Blocs;i++){
        const tr=document.createElement('tr');
        tr.innerHTML='<td>'+i+'</td>'+
          '<td><input type="number" min="0" step="1" id="a_m_'+i+'" placeholder="m"></td>'+
          '<td><input type="number" min="0" max="10" step="1" id="a_r_'+i+'" placeholder="RPE"></td>'+
          '<td><input type="number" min="0" step="1" id="b_m_'+i+'" placeholder="m"></td>'+
          '<td><input type="number" min="0" max="10" step="1" id="b_r_'+i+'" placeholder="RPE"></td>';
        tb.appendChild(tr);
      }
      updateTargets();
    }

    function mPerMin(kmh){ return (kmh*1000)/60; }
    function mean(arr){ return arr.reduce((a,b)=>a+b,0)/arr.length; }

    function updateTargets(){
      const s=current;
      const aV=Number(document.getElementById('aVMA').value||0);
      const bV=Number(document.getElementById('bVMA').value||0);
      const pct = s.Cible_%VMA.length? s.Cible_%VMA : Array(s.Blocs).fill(1);
      const dA = aV? pct.map(p=> Math.round(mPerMin(aV*p)*s.DureeBloc_min)) : [];
      const dB = bV? pct.map(p=> Math.round(mPerMin(bV*p)*s.DureeBloc_min)) : [];
      document.getElementById('targets').innerHTML = (aV||bV)
        ? 'Cibles (m/bloc) ‚Äî A: <b>'+(dA.join(' ‚Ä¢ ')||'‚Äî')+'</b> | B: <b>'+(dB.join(' ‚Ä¢ ')||'‚Äî')+'</b>'
        : 'Renseignez la VMA pour voir vos cibles.';
    }

    function setupTimer(){
      const s=current; phase='Pr√™t'; bloc=0; remaining=0;
      const t=document.getElementById('tclock'), ph=document.getElementById('phase'), idx=document.getElementById('blocIdx');
      function fmt(sec){ const m=Math.floor(sec/60), s=sec%60; return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); }
      function tick(){
        if(remaining>0){ remaining--; t.textContent=fmt(remaining); }
        else{
          if(phase==='Pr√™t' || phase==='R√©cup'){
            if(bloc>=current.Blocs){ clearInterval(timer); ph.textContent='Termin√©'; return; }
            bloc++; idx.textContent=bloc; phase='Effort'; ph.textContent='Effort'; remaining=current.DureeBloc_min*60; t.textContent=fmt(remaining);
          }else{
            if(current.Recup_min>0){ phase='R√©cup'; ph.textContent='R√©cup'; remaining=current.Recup_min*60; t.textContent=fmt(remaining); }
            else{
              if(bloc>=current.Blocs){ clearInterval(timer); ph.textContent='Termin√©'; return; }
              bloc++; idx.textContent=bloc; phase='Effort'; ph.textContent='Effort'; remaining=current.DureeBloc_min*60; t.textContent=fmt(remaining);
            }
          }
        }
      }
      document.getElementById('tStart').onclick = ()=>{ if(timer) clearInterval(timer); tick(); timer=setInterval(tick,1000); };
      document.getElementById('tPause').onclick = ()=>{ if(timer) clearInterval(timer); };
      document.getElementById('tReset').onclick = ()=>{ if(timer) clearInterval(timer); phase='Pr√™t'; bloc=0; remaining=0; ph.textContent='Pr√™t'; t.textContent='00:00'; idx.textContent='0'; };
    }

    function kmh(total_m, total_min){ return (total_m/1000)/(total_min/60); }

    function genPayload(mode){
      const s=current, n=s.Blocs;
      const A={ Nom:(document.getElementById('aNom').value||'').toUpperCase(), Pr√©nom:document.getElementById('aPrenom').value||'', Classe:document.getElementById('aClasse').value||'', Sexe:document.getElementById('aSexe').value||'', VMA:Number(document.getElementById('aVMA').value||0) };
      const B={ Nom:(document.getElementById('bNom').value||'').toUpperCase(), Pr√©nom:document.getElementById('bPrenom').value||'', Classe:document.getElementById('bClasse').value||'', Sexe:document.getElementById('bSexe').value||'', VMA:Number(document.getElementById('bVMA').value||0) };
      const am=[], ar=[], bm=[], br=[]; for(let i=1;i<=n;i++){ am.push(Number(document.getElementById(`a_m_${i}`).value||0)); ar.push(Number(document.getElementById(`a_r_${i}`).value||0)); bm.push(Number(document.getElementById(`b_m_${i}`).value||0)); br.push(Number(document.getElementById(`b_r_${i}`).value||0)); }

      const totalMin = s.Blocs * s.DureeBloc_min;
      const vA = kmh(am.reduce((a,b)=>a+b,0), totalMin);
      const vB = kmh(bm.reduce((a,b)=>a+b,0), totalMin);
      const pct = s.Cible_%VMA.length? s.Cible_%VMA : Array(s.Blocs).fill(1);
      const cibleA = A.VMA? (A.VMA * mean(pct)) : 0;
      const cibleB = B.VMA? (B.VMA * mean(pct)) : 0;
      const ecA = +(vA - cibleA).toFixed(2);
      const ecB = +(vB - cibleB).toFixed(2);

      if(mode==='duo'){
        return { v:1, format:'duo', SeanceID:s.SeanceID, Seance:s.Titre, Piste_m:s.Piste_m,
          eleves:[
            { Nom:A.Nom, Pr√©nom:A.Pr√©nom, Classe:A.Classe, Sexe:A.Sexe, VMA:A.VMA, Blocs_m:am, RPE:ar, Vitesse_moy_km_h:+vA.toFixed(2), Ecart_km_h:ecA },
            { Nom:B.Nom, Pr√©nom:B.Pr√©nom, Classe:B.Classe, Sexe:B.Sexe, VMA:B.VMA, Blocs_m:bm, RPE:br, Vitesse_moy_km_h:+vB.toFixed(2), Ecart_km_h:ecB }
          ] };
      } else if(mode==='soloA'){
        return { v:1, format:'solo', SeanceID:s.SeanceID, Seance:s.Titre, Piste_m:s.Piste_m,
          Nom:A.Nom, Pr√©nom:A.Pr√©nom, Classe:A.Classe, Sexe:A.Sexe, VMA:A.VMA, Blocs_m:am, RPE:ar, Vitesse_moy_km_h:+vA.toFixed(2), Ecart_km_h:ecA };
      } else {
        return { v:1, format:'solo', SeanceID:s.SeanceID, Seance:s.Titre, Piste_m:s.Piste_m,
          Nom:B.Nom, Pr√©nom:B.Pr√©nom, Classe:B.Classe, Sexe:B.Sexe, VMA:B.VMA, Blocs_m:bm, RPE:br, Vitesse_moy_km_h:+vB.toFixed(2), Ecart_km_h:ecB };
      }
    }

    function showQR(mode){
      const payload = genPayload(mode);
      const json = JSON.stringify(payload);
      const url = 'https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=' + encodeURIComponent(json);
      document.getElementById('qrResult').innerHTML = '<div class="row"><img alt="QR" src="'+url+'"><textarea style="width:100%;margin-top:10px" rows="5">'+json+'</textarea></div>';
    }

    document.getElementById('btnLoad').addEventListener('click', loadFromCode);
    document.getElementById('aVMA').addEventListener('input', updateTargets);
    document.getElementById('bVMA').addEventListener('input', updateTargets);
    document.getElementById('ePiste').addEventListener('input', ()=>{ if(current){ current.Piste_m = Number(document.getElementById('ePiste').value||200); renderSeance(); updateTargets(); } });

    document.getElementById('btnQRDuo').addEventListener('click', ()=>showQR('duo'));
    document.getElementById('btnQRA').addEventListener('click', ()=>showQR('soloA'));
    document.getElementById('btnQRB').addEventListener('click', ()=>showQR('soloB'));
  </script>
</body>
</html>
