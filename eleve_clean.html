<!DOCTYPE html><html lang="fr"><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RunCycle — Élève (clean)</title>
<style>
:root{--line:#cbd5e1}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:20px;max-width:900px}
h1{margin:0 0 10px} .card{border:1px solid var(--line);border-radius:10px;padding:12px;margin:10px 0}
.grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
label{display:block;margin-bottom:4px} input,select,button{font-size:18px;padding:10px}
button{cursor:pointer}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:4px 8px}
.time{font:700 28px/1 ui-monospace,Menlo,Consolas,monospace;border:1px solid var(--line);padding:8px 10px;border-radius:8px}
table{width:100%;border-collapse:collapse} th,td{border:1px solid var(--line);padding:6px;text-align:left}
</style>
<h1>RunCycle — Élèves (clean)</h1>
<div class="card">
  <h2>Charger la séance</h2>
  <div class="grid">
    <div><label>Code séance</label><input id="code" placeholder="202B"></div>
    <div><label>Piste (m)</label><input id="piste" type="number" min="50" value="200"></div>
  </div>
  <p><button onclick="load()">Utiliser le code</button> <span id="desc" class="badge" style="display:none"></span></p>
</div>
<div id="profiles" class="grid" style="display:none">
  <div class="card"><h3>Élève A</h3><div class="grid">
    <div><label>Nom</label><input id="aNom"></div><div><label>Prénom</label><input id="aPre"></div>
    <div><label>Classe</label><input id="aCla"></div><div><label>Sexe</label><select id="aSex"><option>F</option><option>M</option></select></div>
    <div><label>VMA (km/h)</label><input id="aVMA" type="number" step="0.1" oninput="targets()"></div>
  </div></div>
  <div class="card"><h3>Élève B</h3><div class="grid">
    <div><label>Nom</label><input id="bNom"></div><div><label>Prénom</label><input id="bPre"></div>
    <div><label>Classe</label><input id="bCla"></div><div><label>Sexe</label><select id="bSex"><option>F</option><option selected>M</option></select></div>
    <div><label>VMA (km/h)</label><input id="bVMA" type="number" step="0.1" oninput="targets()"></div>
  </div></div>
</div>
<div id="work" class="card" style="display:none">
  <h2>Cibles & Chrono</h2>
  <div id="tg" class="badge">Renseignez les VMA…</div>
  <p><span id="phase" class="badge">Prêt</span> <span id="clock" class="time">00:00</span> 
  <button id="bStart">Start</button> <button id="bPause">Pause</button> <button id="bReset">Reset</button>
  <span class="badge">Bloc <span id="i">0</span>/<span id="n">0</span></span></p>
  <div id="finished" class="badge" style="display:none">Séance terminée</div>
</div>
<div id="saisie" class="card" style="display:none">
  <h2>Saisie</h2>
  <table><thead><tr><th>Bloc</th><th>Distance A (m)</th><th>RPE A</th><th>Distance B (m)</th><th>RPE B</th></tr></thead><tbody id="tb"></tbody></table>
  <p><button onclick="qr('duo')">QR DUO</button> <button onclick="qr('A')">QR A</button> <button onclick="qr('B')">QR B</button></p>
  <div id="q"></div>
</div>
<script>
const PRESETS={"101A":{T:"Test 6' (VMA)",B:1,Db:6,R:0,P:[]},
"202B":{T:"2×6' @90% (r=3')",B:2,Db:6,R:3,P:[0.9,0.9]},
"303C":{T:"3×4' 80/90/100% (r=2')",B:3,Db:4,R:2,P:[0.8,0.9,1.0]},
"404D":{T:"4×3' 90→95% (r=2')",B:4,Db:3,R:2,P:[0.9,0.92,0.94,0.95]},
"505E":{T:"Éval 4×3' @95% (r=2')",B:4,Db:3,R:2,P:[0.95,0.95,0.95,0.95]}};
let S=null, running=false, rem=0, ph='Prêt', b=0;
function load(){
  const c=(document.getElementById('code').value||'').trim().toUpperCase(); if(!PRESETS[c]){alert('Code inconnu : 101A..505E');return;}
  const piste=+document.getElementById('piste').value||200, p=PRESETS[c]; S={T:p.T,B:p.B,Db:p.Db,R:p.R,P:p.P,Piste:piste};
  document.getElementById('desc').style.display='inline-block'; document.getElementById('desc').textContent=p.T+' • '+p.B+'×'+p.Db+"' r="+p.R+"' • piste "+piste+' m';
  document.getElementById('profiles').style.display='grid'; document.getElementById('work').style.display='block'; document.getElementById('saisie').style.display='block';
  document.getElementById('n').textContent=S.B; build(); targets(); reset();
  document.getElementById('bStart').onclick=start; document.getElementById('bPause').onclick=pause; document.getElementById('bReset').onclick=reset;
}
function build(){ const tb=document.getElementById('tb'); tb.innerHTML=''; for(let i=1;i<=S.B;i++){tb.insertAdjacentHTML('beforeend','<tr><td>'+i+'</td><td><input id=a_m_'+i+' type=number min=0></td><td><input id=a_r_'+i+' type=number min=0 max=10></td><td><input id=b_m_'+i+' type=number min=0></td><td><input id=b_r_'+i+' type=number min=0 max=10></td></tr>');}}
function mpm(k){return k*1000/60}
function targets(){ const a=+document.getElementById('aVMA').value||0, b=+document.getElementById('bVMA').value||0, pct=S.P.length?S.P:Array(S.B).fill(1);
  const dA=a?pct.map(p=>Math.round(mpm(a*p)*S.Db)):[], dB=b?pct.map(p=>Math.round(mpm(b*p)*S.Db)):[];
  document.getElementById('tg').innerHTML=(a||b)?('Cibles — A: <b>'+ (dA.join(' • ')||'—') + '</b> | B: <b>' + (dB.join(' • ')||'—') + '</b>'):'Renseignez les VMA…';}
function fmt(s){const m=Math.floor(s/60),x=s%60;return String(m).padStart(2,'0')+':'+String(x).padStart(2,'0');}
function setPhase(p,sec){ph=p;rem=sec;document.getElementById('phase').textContent=p;document.getElementById('clock').textContent=fmt(rem);}
function tick(){
  if(!running)return;
  if(rem>0){rem--;document.getElementById('clock').textContent=fmt(rem);return;}
  if(ph==='Effort'){
    if(b>=S.B){stopAll(true);return;}
    if(S.R>0){setPhase('Récup',S.R*60);}else{b++;document.getElementById('i').textContent=b;setPhase('Effort',S.Db*60);}
    return;
  }
  if(ph==='Prêt'){b=1;document.getElementById('i').textContent=b;setPhase('Effort',S.Db*60);return;}
  if(ph==='Récup'){b++;document.getElementById('i').textContent=b;setPhase('Effort',S.Db*60);return;}
}
function start(){ if(!S||running)return; running=true; document.getElementById('finished').style.display='none'; if(rem<=0){ if(ph==='Prêt'){setPhase('Effort',S.Db*60);} } if(window._t)clearInterval(window._t); window._t=setInterval(tick,1000); }
function pause(){ running=false; if(window._t)clearInterval(window._t);}
function stopAll(f){ running=false; if(window._t)clearInterval(window._t); document.getElementById('phase').textContent=f?'Terminé':'Prêt'; document.getElementById('clock').textContent='00:00'; if(f)document.getElementById('finished').style.display='inline-block';}
function reset(){ stopAll(false); ph='Prêt'; b=0; rem=0; document.getElementById('i').textContent='0'; document.getElementById('finished').style.display='none';}
function kmh(m, min){ return (m/1000)/(min/60) } function mean(a){ return a.reduce((x,y)=>x+y,0)/a.length }
function qr(mode){
  const n=S.B,a={Nom:(document.getElementById('aNom').value||'').toUpperCase(),Prénom:document.getElementById('aPre').value||'',Classe:document.getElementById('aCla').value||'',Sexe:document.getElementById('aSex').value||'',VMA:+document.getElementById('aVMA').value||0},
        b={Nom:(document.getElementById('bNom').value||'').toUpperCase(),Prénom:document.getElementById('bPre').value||'',Classe:document.getElementById('bCla').value||'',Sexe:document.getElementById('bSex').value||'',VMA:+document.getElementById('bVMA').value||0};
  const am=[],ar=[],bm=[],br=[];for(let i=1;i<=n;i++){am.push(+document.getElementById('a_m_'+i).value||0);ar.push(+document.getElementById('a_r_'+i).value||0);bm.push(+document.getElementById('b_m_'+i).value||0);br.push(+document.getElementById('b_r_'+i).value||0);}
  const totMin=S.B*S.Db, vA=kmh(am.reduce((x,y)=>x+y,0),totMin), vB=kmh(bm.reduce((x,y)=>x+y,0),totMin), pct=S.P.length?S.P:Array(S.B).fill(1),
        cibleA=a.VMA?(a.VMA*mean(pct)):0, cibleB=b.VMA?(b.VMA*mean(pct)):0, ecA=+(vA-cibleA).toFixed(2), ecB=+(vB-cibleB).toFixed(2);
  let payload=null;
  if(mode==='duo'){ payload={v:1,format:'duo',Seance:S.T,Piste_m:S.Piste,eleves:[{Nom:a.Nom,Prénom:a.Prénom,Classe:a.Classe,Sexe:a.Sexe,VMA:a.VMA,Blocs_m:am,RPE:ar,Vitesse_moy_km_h:+vA.toFixed(2),Ecart_km_h:ecA},{Nom:b.Nom,Prénom:b.Prénom,Classe:b.Classe,Sexe:b.Sexe,VMA:b.VMA,Blocs_m:bm,RPE:br,Vitesse_moy_km_h:+vB.toFixed(2),Ecart_km_h:ecB}]}; }
  else if(mode==='A'){ payload={v:1,format:'solo',Seance:S.T,Piste_m:S.Piste,Nom:a.Nom,Prénom:a.Prénom,Classe:a.Classe,Sexe:a.Sexe,VMA:a.VMA,Blocs_m:am,RPE:ar,Vitesse_moy_km_h:+vA.toFixed(2),Ecart_km_h:ecA}; }
  else { payload={v:1,format:'solo',Seance:S.T,Piste_m:S.Piste,Nom:b.Nom,Prénom:b.Prénom,Classe:b.Classe,Sexe:b.Sexe,VMA:b.VMA,Blocs_m:bm,RPE:br,Vitesse_moy_km_h:+vB.toFixed(2),Ecart_km_h:ecB}; }
  const json=JSON.stringify(payload), url='https://api.qrserver.com/v1/create-qr-code/?size=220x220&data='+encodeURIComponent(json);
  document.getElementById('q').innerHTML='<div><img alt="QR" src="'+url+'"><textarea rows="5" style="width:100%;margin-top:8px">'+json+'</textarea></div>';
}
</script>
</html>